<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>節奏王 v1.5 - 音符分組版</title>
  <style>
    :root { font-family: system-ui, sans-serif; }
    body { margin: 18px; line-height: 1.45; background-color: #f9f9f9; }
    .box { border: 1px solid #e5e5e5; border-radius: 12px; padding: 14px; background: white; margin-bottom: 12px; }
    button { padding: 10px 14px; cursor: pointer; border-radius: 6px; border: 1px solid #ccc; font-weight: bold; }
    button:disabled { opacity: 0.5; }
    #log { font-family: monospace; font-size: 11px; background: #222; color: #0f0; padding: 10px; border-radius: 6px; height: 120px; overflow-y: auto; }
    #score { overflow-x: auto; background: white; border: 1px solid #eee; min-height: 180px; display: flex; align-items: center; padding: 10px; }
    .status-pill { padding: 4px 10px; border-radius: 999px; background: #eee; font-size: 14px; margin-left: 5px; }
    .highlight { color: #15803d; font-weight: bold; }
  </style>
</head>
<body>
  <h1>節奏王 v1.5</h1>

  <div class="box">
    <button id="btnStart">開始錄入</button>
    <button id="btnStop" disabled>Space 結束</button>
    <button id="btnReset">重置系統</button>
    <span class="status-pill">狀態：<b id="statusText">載入中...</b></span>
    <span class="status-pill">音符：<b id="noteCount">0</b></span>
    <span class="status-pill">速度：<b id="bpmText">—</b> BPM</span>
  </div>

  <div id="score"></div>

  <div class="box" style="background: #222;">
    <b style="color: white; font-size: 12px;">系統開發日誌 (Grouping & Beaming)</b>
    <div id="log">正在啟動音樂引擎...</div>
  </div>

  <script type="module">
    const $ = (id) => document.getElementById(id);
    const logEl = $("log");
    
    function sysLog(msg, isError = false) {
      const time = new Date().toLocaleTimeString();
      const div = document.createElement("div");
      div.style.color = isError ? "#ff4444" : "#0f0";
      div.textContent = `[${time}] ${msg}`;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    // 1. 載入引擎
    let VF = null;
    try {
      const Vex = await import("https://unpkg.com/vexflow@5.0.0/build/esm/entry/vexflow.js");
      VF = Vex;
      sysLog("VexFlow 5.0 引擎加載成功。");
    } catch (err) {
      sysLog("加載失敗: " + err.message, true);
    }

    let isRecording = false, times = [], lastKeyTime = -1;
    const MAX_NOTES = 100, DEBOUNCE = 50;

    // 2. 時值拆解函數：確保符合拍子邊界
    function getDurations(units, isRest=false) {
      const opts = [
        {u:16, d:"w"}, {u:1
